<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>猴猴聊天</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", Calibri, sans-serif;
      margin: 20px;
    }
    #chatBox {
      border: 1px solid #ccc;
      padding: 10px;
      height: 300px;
      overflow-y: scroll;
    }
    .user { color: blue; }
    .bot { color: green; }
    input[type="text"] {
      width: 50%;
      padding: 5px;
    }
    button {
      padding: 5px 10px;
    }
  </style>
</head>
<body>

  <h2>猴猴聊天</h2>
  <div id="chatBox"></div>
  <br>
  <textarea id="userInput" placeholder="輸入訊息..." rows="2" style="width: 50%; padding: 5px;"></textarea>
  <button onclick="loadHistory()">對話紀錄</button>
  <button onclick="clearChat()">清除對話</button>

  <script>
    async function verifyPasswordBeforeUse() {
      const granted = localStorage.getItem("access_granted");
      if (granted === "yes") return;

      const password = prompt("請輸入密碼以使用聊天機器人：");
      if (!password) {
        alert("未輸入密碼");
        history.back();
        return;
      }

      try {
        const res = await fetch(`http://192.168.86.25:8000/verify`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password })
        });

        if (res.status === 200) {
          localStorage.setItem("access_granted", "yes");
        } else {
          alert("密碼錯誤！");
          location.reload();
        }
      } catch (error) {
        alert("伺服器無法連線，請確認後端已啟動");
      }
    }

    verifyPasswordBeforeUse();  // 頁面載入時執行
    const user_id = "user123";  // 固定 ID
    const input = document.getElementById("userInput");
    const SERVER_IP = "192.168.86.25";  // 電腦 IP
    const SERVER_PORT = "8000";
    const BASE_URL = `http://${SERVER_IP}:${SERVER_PORT}`;

    // 按下 Enter 就送出訊息，支援shift + enter 換行輸入
    input.addEventListener("keydown", function (event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();  // 防止換行或表單提交
        sendMessage();
      }
    });

    // 傳送訊息給後端
    async function sendMessage() {
      const msg = input.value;
      if (!msg.trim()) return;

      addMessage("你", msg, "user");

      try {
        const res = await fetch(`${BASE_URL}/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id, message: msg })
        });

        const data = await res.json();
        addMessage("聊天猴", data.reply, "bot");

      } catch (err) {
        console.error("⚠️ 發送失敗：", err);
        addMessage("聊天猴", "抱歉，伺服器好像出問題了！", "bot");
      }

      input.value = "";    // 清空輸入
      input.focus();       // 聚焦輸入
    }

    // 加入訊息顯示
    function addMessage(sender, msg, role) {
      const box = document.getElementById("chatBox");
      // JavaScript 動態插入 <div class ....></div>
      box.insertAdjacentHTML("beforeend",
        `<div class="${role}"><b>${sender}:</b> ${msg}</div>`
      );
      box.scrollTop = box.scrollHeight;
    }

    // 查詢歷史紀錄
    async function loadHistory() {
      try {
        const res = await fetch(`${BASE_URL}/history?user_id=${user_id}`);
        const data = await res.json();
        const box = document.getElementById("chatBox");
        box.innerHTML = "";

        data.history.forEach(e => {
          const sender = e.role === "user" ? "你" : "聊天猴";
          addMessage(sender, e.message, e.role);
        });
      } catch (err) {
        console.error("⚠️ 載入歷史失敗：", err);
        addMessage("系統", "無法載入歷史紀錄", "bot");
      }
    }

    // 清除對話框的對話紀錄，不會清除資料庫中的紀錄
    function clearChat() {
      const confirmed = confirm("你確定要清除對話紀錄嗎？");
      if (confirmed) {
        document.getElementById("chatBox").innerHTML = "";
      }
    }
  </script>

</body>
</html>
