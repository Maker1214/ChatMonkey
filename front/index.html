<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>èŠå¤©çŒ´</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", Calibri, sans-serif;
      margin: 20px;
    }
    #chatBox {
      border: 1px solid #ccc;
      padding: 10px;
      height: 300px;
      overflow-y: scroll;
    }
    .user { color: blue; }
    .bot { color: green; }
    input[type="text"] {
      width: 50%;
      padding: 5px;
    }
    button {
      padding: 5px 10px;
    }
  </style>
</head>
<body>

  <h2>èŠå¤©æ©Ÿå™¨äºº</h2>
  <div id="chatBox"></div>
  <br>
  <input id="userInput" type="text" placeholder="è¼¸å…¥è¨Šæ¯...">
  <button onclick="loadHistory()">What monkey remember</button>

  <script>
    const user_id = "user123";  // å‡è¨­å›ºå®š ID
    const input = document.getElementById("userInput");

    // âŒ¨ï¸ æŒ‰ä¸‹ Enter å°±é€å‡ºè¨Šæ¯
    input.addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        event.preventDefault();  // é˜²æ­¢æ›è¡Œæˆ–è¡¨å–®æäº¤
        sendMessage();
      }
    });

    // ğŸš€ å‚³é€è¨Šæ¯çµ¦å¾Œç«¯
    async function sendMessage() {
      const msg = input.value;
      if (!msg.trim()) return;

      addMessage("ä½ ", msg, "user");

      try {
        const res = await fetch("http://localhost:8000/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id, message: msg })
        });

        const data = await res.json();
        addMessage("èŠå¤©çŒ´", data.reply, "bot");

      } catch (err) {
        console.error("âš ï¸ ç™¼é€å¤±æ•—ï¼š", err);
        addMessage("èŠå¤©çŒ´", "æŠ±æ­‰ï¼Œä¼ºæœå™¨å¥½åƒå‡ºå•é¡Œäº†ï¼", "bot");
      }

      input.value = "";    // âœ… æ¸…ç©ºè¼¸å…¥
      input.focus();       // âœ… èšç„¦è¼¸å…¥
    }

    // ğŸ’¬ åŠ å…¥è¨Šæ¯é¡¯ç¤º
    function addMessage(sender, msg, role) {
      const box = document.getElementById("chatBox");
      box.insertAdjacentHTML("beforeend",
        `<div class="${role}"><b>${sender}:</b> ${msg}</div>`
      );
      box.scrollTop = box.scrollHeight;
    }

    // ğŸ§  æŸ¥è©¢æ­·å²ç´€éŒ„
    async function loadHistory() {
      try {
        const res = await fetch(`http://localhost:8000/history?user_id=${user_id}`);
        const data = await res.json();
        const box = document.getElementById("chatBox");
        box.innerHTML = "";

        data.history.forEach(e => {
          const sender = e.role === "user" ? "ä½ " : "èŠå¤©çŒ´";
          addMessage(sender, e.message, e.role);
        });
      } catch (err) {
        console.error("âš ï¸ è¼‰å…¥æ­·å²å¤±æ•—ï¼š", err);
        addMessage("ç³»çµ±", "ç„¡æ³•è¼‰å…¥æ­·å²ç´€éŒ„", "bot");
      }
    }
  </script>

</body>
</html>
